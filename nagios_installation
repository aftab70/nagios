#!/bin/bash

set -e

apt-get update 
apt-get -y install build-essential apache2 php openssl perl make php-gd libgd-dev libapache2-mod-php libperl-dev libssl-dev daemon wget apache2-utils unzip

useradd -s /bin/false secure-nagios
groupadd secure-nagcmd
usermod -a -G secure-nagcmd secure-nagios
usermod -a -G secure-nagcmd www-data

cd /tmp && wget https://assets.nagios.com/downloads/nagioscore/releases/nagios-4.4.3.tar.gz
tar -zxvf /tmp/nagios-4.4.3.tar.gz
cd /tmp/nagios-4.4.3/
./configure --with-nagios-group=secure-nagios --with-command-group=secure-nagcmd --with-nagios-user=secure-nagios --with-httpd_conf=/etc/apache2/sites-enabled/
make all
make install
make install-init
make install-config
make install-commandmode
make install-webconf

htpasswd -c /usr/local/nagios/etc/htpasswd.users secure-nagios
a2enmod cgi
systemctl restart apache2
cd /tmp && wget https://nagios-plugins.org/download/nagios-plugins-2.2.1.tar.gz
tar -zxvf /tmp/nagios-plugins-2.2.1.tar.gz
cd /tmp/nagios-plugins-2.2.1/
./configure --with-nagios-user=secure-nagios --with-nagios-group=secure-nagios
make
make install

/usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg

sed -i 's/nagiosadmin/secure-nagios/g' /usr/local/nagios/etc/cgi.cfg
sed -i 's/80/8203/g' /etc/apache2/ports.conf
cp -p /etc/apache2/sites-enabled/nagios.conf /etc/apache2/sites-available/
rm -rf /etc/apache2/sites-enabled/nagios.conf

cd /etc/apache2/sites-available/
a2ensite nagios.conf
sed -i 's@url_html_path=/nagios@url_html_path=/secure-panel@g' /usr/local/nagios/etc/cgi.cfg
sed -i 's@Alias /nagios@Alias /secure-panel@g' /etc/apache2/sites-available/nagios.conf
sed -i 's@/nagios/cgi-bin@/secure-panel/cgi-bin@g' /usr/local/nagios/share/config.inc.php
sed -i 's@/nagios/cgi-bin@/secure-panel/cgi-bin@g' /etc/apache2/sites-available/nagios.conf

systemctl restart apache2
systemctl enable nagios

apt -y install nagios-nrpe-plugin
systemctl restart nagios

openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/ssl/private/apache-selfsigned.key -out /etc/ssl/certs/apache-selfsigned.crt
wget -O /etc/apache2/sites-available/default-ssl.conf  https://raw.githubusercontent.com/aftab70/nagios/master/ssl_config_nagios

2enmod ssl

sed -i 's/443/4433/g' /etc/apache2/ports.conf
cd /etc/apache2/sites-available/
a2ensite default-ssl.conf
service apache2 restart


echo "nagios Core installation is successfull"
echo "Open your browser using http://YOUR_IP:8203/secure-panel/ "
echo "Open your browser using https://YOUR_IP:4433/secure-panel/ "
echo "Your username will be secure-nagios "
echo "############## Author - Aftab Ali ######################"
